AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  CloudFormation template to create ECR repos, ECS Cluster (Fargate), IAM roles,
  CloudWatch Log Groups, Application Load Balancer, Task Definitions and ECS
  Services for the WeatherNow app. Requires existing VPC and subnets.

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to launch ECS services into

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnets (2+) in the VPC for Fargate tasks and ALB

  SecretArn:
    Type: String
    Description: ARN of Secrets Manager secret that stores the OpenWeather API key (optional)
    Default: ''

Resources:
  WeathernowFrontendRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: weathernow-frontend

  WeathernowBackendRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: weathernow-backend

  BackendLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/weathernow-backend
      RetentionInDays: 14

  FrontendLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/weathernow-frontend
      RetentionInDays: 14

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ecsTaskExecutionRole-weathernow
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  WeathernowTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: weathernowTaskRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: weathernow-task-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: SecretsAccess
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !If [HasSecret, !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:weathernow/*", !Ref AWS::NoValue]
              - Sid: CloudWatchLogs
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:CreateLogGroup
                  - logs:DescribeLogStreams
                  - logs:DescribeLogGroups
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/*

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: weathernow-cluster

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks and ALB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: weathernow-alb
      Subnets: !Ref SubnetIds
      SecurityGroups: [!Ref ECSSecurityGroup]
      Scheme: internet-facing

  FrontendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: weathernow-frontend-tg
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VpcId
      TargetType: ip
      HealthCheckPath: /

  BackendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: weathernow-backend-tg
      Port: 5000
      Protocol: HTTP
      VpcId: !Ref VpcId
      TargetType: ip
      HealthCheckPath: /api/health

  ListenerHTTP:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTargetGroup

  BackendListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ListenerHTTP
      Priority: 10
      Conditions:
        - Field: path-pattern
          Values: ['/api/*']
      Actions:
        - Type: forward
          TargetGroupArn: !Ref BackendTargetGroup

  FrontendTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: weathernow-frontend
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt WeathernowTaskRole.Arn
      ContainerDefinitions:
        - Name: frontend
          Image: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/weathernow-frontend:latest"
          PortMappings:
            - ContainerPort: 80
          Essential: true
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: /ecs/weathernow-frontend
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: frontend

  BackendTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: weathernow-backend
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt WeathernowTaskRole.Arn
      ContainerDefinitions:
        - Name: backend
          Image: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/weathernow-backend:latest"
          PortMappings:
            - ContainerPort: 5000
          Essential: true
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: /ecs/weathernow-backend
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: backend
          Secrets: !If
            - HasSecret
            - - Name: WEATHER_API_KEY
                ValueFrom: !Ref SecretArn
            - !Ref AWS::NoValue

  FrontendService:
    Type: AWS::ECS::Service
    DependsOn: ListenerHTTP
    Properties:
      Cluster: !Ref ECSCluster
      ServiceName: weathernow-frontend-service
      LaunchType: FARGATE
      DesiredCount: 1
      TaskDefinition: !Ref FrontendTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          Subnets: !Ref SubnetIds
          SecurityGroups: [!Ref ECSSecurityGroup]
          AssignPublicIp: ENABLED
      LoadBalancers:
        - TargetGroupArn: !Ref FrontendTargetGroup
          ContainerName: frontend
          ContainerPort: 80

  BackendService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref ECSCluster
      ServiceName: weathernow-backend-service
      LaunchType: FARGATE
      DesiredCount: 1
      TaskDefinition: !Ref BackendTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          Subnets: !Ref SubnetIds
          SecurityGroups: [!Ref ECSSecurityGroup]
          AssignPublicIp: ENABLED
      LoadBalancers:
        - TargetGroupArn: !Ref BackendTargetGroup
          ContainerName: backend
          ContainerPort: 5000

Conditions:
  HasSecret: !Not [!Equals [!Ref SecretArn, ""]]

Outputs:
  LoadBalancerDNS:
    Description: DNS name of the ALB
    Value: !GetAtt LoadBalancer.DNSName

  FrontendECRRepoURI:
    Description: ECR repository URI for frontend
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/weathernow-frontend"

  BackendECRRepoURI:
    Description: ECR repository URI for backend
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/weathernow-backend"
